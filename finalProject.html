<!DOCTYPE html>
<html>
  <head>
	<title> She's Not Here </title>
  </head>
  <body>
    <div id="game"></div>
    <script type="text/javascript" src="https://rawgithub.com/craftyjs/Crafty/release/dist/crafty-min.js"></script>
    
	<script>
		Crafty.init(800,600, document.getElementById('game'));	//initiate crafty & window
		
		//SPAWNS ENEMIES
		var ew = true;
		function SpawnEnemy(x, y) {
		ew = true;
		Crafty.e("enemy, 2D, Canvas, Color, Twoway, Gravity, Collision")
		.color('#ff0000')
		.attr({ x: x, y: y, w: 15, h: 40, dX: 2 })
		.gravity('Solid')
		.bind('EnterFrame', function () {
			this.x += this.dX;
		})
		.onHit("Solid", function() {
			this.dX *= -1;
		})
		.onHit("Projectile", function(){
			this.destroy();
			ew = false;
		})
		.bind('EnterFrame', function () {			
			if (this.x <= 0) {
				this.x = 0;
				this.dX *= -1;
			}
		});
		};
		
		/** CLASSES **/
		//template for solids
		Crafty.c('Solid', {
			init: function() {
				this.requires('2D, Canvas, Grid, Color');
				this.color('black');
			},
		});
		
		//template for Player-controlled sprite
		Crafty.c('PlayerC', {
			dir:1, health:30, maxHealth:30, shield:0, slotSelect:1,
			init: function() {
				this.requires('2D, Canvas, Twoway, Gravity, Color, Collision')
					.twoway(4,7)	//built-in movement/jumping function
					.color('black')
					.gravity('Solid')
					.bind('Moved', function(p) {	//executes the function when the 'Moved' event occurs
						if (this.hit('Solid')){
							this.attr({x: p.x});	//so that the sprite can't pass through solids horizontally
						}
					})
					.bind('KeyDown', function(e){	
						//keep track of which direction player is facing
						if(e.key === Crafty.keys.RIGHT_ARROW){
							this.dir = 1;
						}
						else if(e.key === Crafty.keys.LEFT_ARROW){
							this.dir = -1;
						}
						//change ability slot
						if(e.key === Crafty.keys.C){
							this.slotSelect += 1;
							if(this.slotSelect === 12){this.slotSelect = 1;}
						}
						else if(e.key === Crafty.keys.X){
							this.slotSelect -= 1;
							if(this.slotSelect === 1){this.slotSelect = 12;}
						}
					})
					.onHit('enemy', function(){
						return this.health = this.health - 1;
						if (this.health == 0){
							Crafty.enterScene('GameOver');
						}
					})
			}
		});
		
		//template for enemies
		/**Crafty.c('Enemy', {
			init: function(){
				this.requires('2D, Canvas, Gravity, Color, Collision')
					.
			}
		});**/
		
		//template for projectiles (both player & enemy)
		Crafty.c('Projectile', {
			init: function(){
				this.requires('2D, DOM, Color, Collision')
					.bind('EnterFrame', function(){
						this.x += this.xspeed;	//move the bullet
						if(this._x < this._x-Crafty.viewport.width || this._x > this._x+Crafty.viewport.width || this._y < this.y-Crafty.viewport.height || this._y > this.y+Crafty.viewport.height || this.hit('Solid')) {
							this.destroy();	//destroy the bullet if it leaves the visible screen portion
						}
					})
			}
		});
		
		//template for all doors
		Crafty.c('Door', {
			init: function(){
				this.requires('2D, Canvas, Grid, Color, Collision')
					.color('#BBBBBB')
					//enables scene change
					/*.bind('KeyDown', function(e){
						if(e.key === Crafty.keys.DOWN_ARROW && this.hit('PlayerC')){
							Crafty.enterScene('Start');
						}
					});*/
			}
		});
		
		//default template for all text (it can be overwritten for customization)
		Crafty.c('Words', {
			init: function(){
				this.requires('2D, DOM, Text')
					.unselectable()
					.textColor('white')
					.textFont({type:'italic', family:'Verdana'});
			}
		});
		
		
		/** LEVEL SCREENS **/
		//start screen
		Crafty.defineScene('Start', function(){
			Crafty.background('url(http://i.imgur.com/HdmmNJV.png)');
			Crafty.e('Words').attr({x:100, y:100, w: 700, h: 100}).text("She's Not Here").textFont({size:'80px'});
			Crafty.e('Words').attr({x:200, y:250, w: 300, h: 100}).text("Press any key to begin playing").textFont({size:'15px'})
				.bind('KeyDown', function(e){
					Crafty.enterScene('level0');
					spawn(200,550);
				}); 
		});
		
		Crafty.defineScene('GameOver', function(){
			Crafty.background('url (http://i.imgur.com/c2A937j.png)');
			Crafty.e('Words').attr({x: 100, y: 100, w: 600, h: 400}).text("Game Over").textFont({size: '40px'});
		
		});
		
		//tutorial screen
		Crafty.defineScene('level0', function(){
			Crafty.background('#2E2E2F');
			//platforms
			Crafty.e('Solid').attr({x: 0, y: 550, w: 1160, h: 50}); //floor
			Crafty.e('Solid').attr({x: 0, y: 440, w: 400, h: 20});
			Crafty.e('Solid').attr({x:420, y: 335, w: 400, h: 20});
			Crafty.e('Solid').attr({x:770, y: 230, w: 400, h: 20});
			//border
			Crafty.e('Solid').attr({x: 0, y: 0, w: 30, h: 600});	//W side
			Crafty.e('Solid').attr({x: 1160, y: 0, w: 30, h: 600});	//E side 
			Crafty.e('Door').attr({x:790, y: 150, w: 50, h: 80})
			.bind('KeyDown', function(e){
				if(e.key === Crafty.keys.DOWN_ARROW && this.hit('PlayerC')){
					Crafty.enterScene('level1');
					spawn(200, 550);
				}
			});;
			Crafty.e('Words').attr({x:38, y: 50, w: 300, h: 100}).text("^Your health bar.").textFont({size:'20px'});
			Crafty.e('Words').attr({x: 100, y: 100, w: 400}).text("Use WASD or arrow keys to jump/move, SPACEBAR to attack. Press DOWN arrow key while touching a door to enter it.").textColor('#CCCCCC').textFont({size:'20px'});
		});
		
		//ALRIGHT LET'S ADD SOME ENEMIES UP HERE
		Crafty.defineScene('level1', function(){
			Crafty.background('#2E2E2F');
			
				//PLATFORMS
			Crafty.e('Solid').attr({x: 0, y: 550, w: 1600, h: 50});
			Crafty.e('Solid').attr({x: 0, y: 420, w: 400, h: 20});
			Crafty.e('Solid').attr({x: 770, y: 230, w: 400, h: 20});
			//BORDER
			Crafty.e('Solid').attr({x: 0, y: 0, w: 30, h: 600});	//W side
			Crafty.e('Solid').attr({x: 1600, y: 0, w: 30, h: 600});	//E side 
			//EXIT
			Crafty.e('Door').attr({x:800, y: 130, w: 50, h: 100})
			.bind('KeyDown', function(e){
				if(e.key === Crafty.keys.DOWN_ARROW && this.hit('PlayerC') && ew == false){
				Crafty.enterScene('level2');
			}
			});
			
			
			SpawnEnemy(770, 140);
		});
		
		/** INITIATIONS **/
		//start scene
		Crafty.enterScene('Start');
		//spawns player & misc.
		var playerw = 30;
		var playerh = 50;
		var spawn = function(xpos, ypos){
			var player = Crafty.e('PlayerC').attr({x: xpos, y: ypos, w: playerw, h: playerh});
			Crafty.viewport.follow(player,0,0);			//camera to follow player
			//health bar
			var healthBarOutline = Crafty.e('2D, Canvas, Color')
				.attr({x: -Crafty.viewport._x+38, y: Crafty.viewport._y+25, w: player.health*2+10, h: 30})
				.color('black');
			var healthBar = Crafty.e('2D, Canvas, Color')
				.attr({x: -Crafty.viewport._x+43, y: Crafty.viewport._y+30, w: player.health*2, h: 20})
				.color('green');
			//ability slots
			var slotBarOutline = Crafty.e('2D, Canvas, Color')
				.attr({x: -Crafty.viewport._x+300, y: -Crafty.viewport._y+25, w:490, h:50})
				.color('black');
			var slotBars = Crafty.e('2D, DOM, Image')
				.attr({x: -Crafty.viewport._x+305, y: -Crafty.viewport._y+30, w: 480, h:40})
				.image('http://i.imgur.com/oVWgV3l.png');
			
			//update health & ability slot bars
			player.bind('Moved', function(){
				healthBarOutline.destroy();
				healthBar.destroy();
				slotBarOutline.destroy();
				slotBars.destroy();
				healthBarOutline = Crafty.e('2D, Canvas, Color')
					.attr({x: -Crafty.viewport._x+38, y: -Crafty.viewport._y+25, w: player.health*2+10, h: 30})
					.color('black');
				healthBar = Crafty.e('2D, Canvas, Color')
					.attr({x: -Crafty.viewport._x+43, y: -Crafty.viewport._y+30, w: player.health*2, h: 20})
					.color('green');
				slotBarOutline = Crafty.e('2D, Canvas, Color')
					.attr({x: -Crafty.viewport._x+300, y: -Crafty.viewport._y+25, w:490, h:50})
					.color('black');
				slotBars = Crafty.e('2D, DOM, Image')
					.attr({x: -Crafty.viewport._x+305, y: -Crafty.viewport._y+30, w: 480, h:40})
					.image('http://i.imgur.com/oVWgV3l.png');
			});
			
		/** ABILITIES **/
			player.bind('KeyDown', function(e) {
				//sword
				//super strength
				//gemini????
				//body shield
				//roar
				//invisibility
				//healing
				if(player.slotSelect === 7){
					if(e.key === Crafty.keys.SPACE){
						player.health += 30;
						if(player.health > player.maxHealth){player.health = player.maxHealth;}
					}
				}
				//poison darts
				else if(player.slotSelect === 8){
					if(e.key === Crafty.keys.SPACE){
						Crafty.e('Projectile').attr({x: this._x, y: this._y + 0.5*playerh, w: 15, h: 10, xspeed: 7*player.dir}).color('#2C7A32');
					}
				}
				//arrows
				else if(player.slotSelect === 9){
					if(e.key === Crafty.keys.SPACE){
						Crafty.e('Projectile').attr({x: this._x, y: this._y + 0.3*playerh, w: 25, h: 5, xspeed: 10*player.dir}).color('#6E5023');
					}
				}
				//double jump
				else if(player.slotSelect === 10){	
					if (!this._falling && e.key === Crafty.keys.UP_ARROW) {
						this._canJumpAgain = true;} 
					else if (this._canJumpAgain && e.key === Crafty.keys.UP_ARROW) {
						this._up = true;
						this._gy = 0;
						this._canJumpAgain = false;
					}
				}
				//water blast or tsunami
				//breathe underwater
			});
		}
    </script>
  </body>
</html>
